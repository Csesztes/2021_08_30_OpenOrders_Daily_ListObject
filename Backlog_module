
Public Sub Createbacklogfolder()

Dim daily As Date
    daily = Date

    On Error GoTo leave
    MkDir "C:\Users\cscsontos\Desktop\backlog\" & daily
    MsgBox "Folder has been  created!"
    Exit Sub
leave:
MsgBox "Folder already exists!"

End Sub

Public Sub BacklogSaveToXlS()

Application.DisplayAlerts = False

        Dim besz As Long, x As String
        besz = ThisWorkbook.Worksheets("Order").Range("E1")
        x = Application.WorksheetFunction.VLookup(besz, ThisWorkbook.Sheets("törzsadat").Range("A1:F1427"), 2, False)
                    
        Dim wb As Workbook, wbs As Workbook
        Dim ws As Worksheet, NewWs As Worksheet
        Set wb = Workbooks.Add: wb.SaveAs Filename:="C:\Users\cscsontos\Desktop\backlog\" & Date & "\" & besz & "_" & x & "_" & Date & "Backlog" & ".xls"
        Set wbs = ThisWorkbook
        
        Set ws = ThisWorkbook.Sheets("Order")
        Set NewWs = wb.Sheets("Sheet1")
        
        With ws.Range("B2:U2")
            .AutoFilter Field:=3, Criteria1:=besz
            .AutoFilter Field:=1, Criteria1:="BACKLOG"
        End With
        
        ws.Range("B2").CurrentRegion.Copy Destination:=NewWs.Range("A1")
        With wb.Worksheets(1)
            .UsedRange.EntireColumn.AutoFit
            .Range("A1").EntireRow.Delete
            .Range("O:U").EntireColumn.Delete
            .Range("A1:N1").Interior.Color = vbBlue
            .Range("A1:N1").Font.Color = vbWhite
        End With
        
        ActiveWindow.DisplayGridlines = False
        wb.Close True
        ws.Range("b2:u2").AutoFilter

End Sub

Sub BacklogSendMail()

Call BacklogSaveToXlS

Dim daily As Date, besz As Long, x As String
daily = Date
besz = ThisWorkbook.Worksheets("Order").Range("E1")
x = Application.WorksheetFunction.VLookup(besz, ThisWorkbook.Sheets("törzsadat").Range("A1:F427"), 2, False)
            
Dim megszólítás As String
megszólítás = Application.WorksheetFunction.VLookup(besz, ThisWorkbook.Worksheets("törzsadat").Range("A2:F426"), 6, False)
Dim wbs As Workbook
Set wbs = ThisWorkbook

Dim hunbody As String, engbody As String
hunbody = "Kedves" & " " & megszólítás & "," & vbNewLine & vbNewLine & "Ez egy automata üzenet az elmaradásban lévő tételekről." _
& vbNewLine & vbNewLine & "Kérem ellenőrizze és igazolja vissza az elmaradásban lévő rendeléseket." & vbNewLine & _
"Amennyiben már megbeszéltük vagy az áru úton van, kérem tekintse semmisnek levelem." & vbNewLine & vbNewLine & "Válaszát előre is köszönöm." & _
vbNewLine & vbNewLine & "Üdvözlettel:" & vbNewLine & "Csaba"

engbody = "Dear" & " " & megszólítás & "," & vbNewLine & vbNewLine & "You may see an automatically generated backlog file attached." & vbNewLine & vbNewLine _
& "If you have lines which are in backlog for more then a week, then please let me know ASAP about best eta and qt and the reason for the delay for each line." _
& vbNewLine & "If we have discussed the backlogs already, or the goods are in transit, or the goods are already at Haldex but not booked yet, then please feel free toignore this mail." _
& vbNewLine & vbNewLine & "Thank you in advance for your support." & vbNewLine & vbNewLine & "Best Regards" & vbNewLine & "Csaba"

    
 Dim OutlookApp As Object
 Dim OutlookMail As Object
 Set OutlookApp = CreateObject("Outlook.Application")
 Set OutlookMail = OutlookApp.CreateItem(0)
 On Error Resume Next
 
  Dim Recipient As String
  Recipient = Application.WorksheetFunction.VLookup(besz, wbs.Worksheets("törzsadat").Range("A2:F426"), 4, False)
  
  Dim attachementXLS As String
  attachementXLS = "C:\Users\cscsontos\Desktop\backlog\" & daily & "\" & besz & "_" & x & "_" & Date & "Backlog" & ".xls"
  
  Dim SupplierLanguage As String
  SupplierLanguage = Application.WorksheetFunction.VLookup(besz, wbs.Worksheets("törzsadat").Range("A2:F426"), 3, False)
    
  If SupplierLanguage = "EN" Then
        With OutlookMail
             .To = Recipient
            '.to = "csaba.csontos@haldex.com"
            .CC = ""
            .BCC = ""
            .Subject = "Backlog" & " " & x & " " & Date
            .Body = engbody
            .attachments.Add attachementXLS
            .Send
        End With
        
    ElseIf SupplierLanguage = "HU" Then
        With OutlookMail
            .To = Recipient
           '.to = "csaba.csontos@haldex.com"
            .CC = ""
            .BCC = ""
            .Subject = "Backlog" & " " & x & Date
            .Body = hunbody
            .attachments.Add attachementXLS
            .Send
        End With
      End If
           
Set OutlookMail = Nothing
Set OutlookApp = Nothing

wb.Close
wbs.Sheets("Order").Range("b2:u2").AutoFilter

Application.DisplayAlerts = True

End Sub
Sub BacklogSenderMass()

    On Error GoTo leave

    Dim answer As VbMsgBoxResult
    answer = MsgBox("Are you sure?", vbYesNo + vbQuestion + vbApplicationModal, "Backlog Sender")
    
    If answer = vbYes Then
    
        Call DisableStuff
        
        For Each x In ThisWorkbook.Sheets("BACKLOG kiküldő").Range("A1").CurrentRegion
            ThisWorkbook.Worksheets("Order").Range("E1") = x.Value
            Call BacklogSendMail
        Next x
    Else
        Exit Sub
    End If
    
    Call EnableStuff
    Exit Sub
leave:
    MsgBox "Please create backup folder and restart the code."
    Call EnableStuff
End Sub
